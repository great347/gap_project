name: Run dbt models

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # This permission is crucial for OIDC authentication

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Google Auth
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          project_id: "int-dev-001"
          # Ensure this matches your WIF provider setup EXACTLY
          workload_identity_provider: "projects/226403353486/locations/global/workloadIdentityPools/github/providers/llyod-github"
        
      - name: Set DBT_GOOGLE_PROJECT Env Var
        run: echo "DBT_GOOGLE_PROJECT=int-dev-001" >> $GITHUB_ENV

      # --- Create profiles.yml for dbt connection ---
      - name: Create dbt profiles.yml
        run: |
          mkdir -p ~/.dbt/
          cat <<EOF > ~/.dbt/profiles.yml
          config:
            send_anonymous_usage_stats: False

          # IMPORTANT: 'my_dbt_project' must match the 'profile:' name in your dbt_project.yml
          dbt_llyod_cloud:
            target: dev
            outputs:
              dev:
                type: bigquery
                method: oauth # Uses GOOGLE_APPLICATION_CREDENTIALS set by google-github-actions/auth
                project: "int-dev-001"
                dataset: dbt_dataset # <--- REPLACE WITH YOUR ACTUAL DBT DEVELOPMENT DATASET NAME
                threads: 1
                job_retries: 5
                location: us
                priority: interactive
          EOF

      - name: Set Up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9.17'

      - name: Install requirements
        run: pip install -r requirements.txt
        # If your requirements.txt is in a dbt subfolder, you might need:
        # working-directory: ./dbt 

      # --- dbt commands should be run from the dbt project root ---
      - name: Check connection
        run: dbt debug
        working-directory: ./dbt # <--- Adjust this path if your dbt_project.yml is elsewhere

      - name: Install dbt dependencies
        run: dbt deps
        working-directory: ./dbt # <--- Adjust this path

      - name: Run dbt build
        run: dbt build # Use dbt build for models and tests
        working-directory: ./dbt # <--- Adjust this path

